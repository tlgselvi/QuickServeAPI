name: Nightly DB Backup

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Postgres client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Check DATABASE_URL secret
        run: |
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå DATABASE_URL secret not found"
            echo "Please add DATABASE_URL to repository secrets"
            exit 1
          fi
          echo "‚úÖ DATABASE_URL secret found"

      - name: Dump database
        run: |
          echo "üîÑ Starting database backup..."
          export PGPASSWORD=$(node -e "const u=new URL(process.env.DATABASE_URL);console.log(u.password)")
          export PGUSER=$(node -e "const u=new URL(process.env.DATABASE_URL);console.log(u.username)")
          export PGHOST=$(node -e "const u=new URL(process.env.DATABASE_URL);console.log(u.hostname)")
          export PGPORT=$(node -e "const u=new URL(process.env.DATABASE_URL);console.log(u.port||5432)")
          export PGDATABASE=$(node -e "const u=new URL(process.env.DATABASE_URL);console.log(u.pathname.slice(1))")
          
          pg_dump -h "$PGHOST" -p "$PGPORT" -U "$PGUSER" -d "$PGDATABASE" -F c -Z 9 -f backup.dump
          echo "‚úÖ Database backup completed"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: db-backup-${{ github.run_id }}
          path: backup.dump
          retention-days: 30

